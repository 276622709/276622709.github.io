---
layout: post
title: k8s部署jenkins
date: 2021-02-08
author: ZMY
header-img: ../img/2021-02-08/background.png
catalog : true
tags:
   - kubernetes
   - jenkins
typora-root-url: ..
---

## <img class="original" src='/img/original.png'>k8s部署jenkins

**环境描述**

| 主机名 | ip地址          | 操作系统                      | K8S版本 | 备注 |
| ------ | --------------- | ----------------------------- | ------- | ---- |
| master | 192.168.140.210 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node1  | 192.168.140.211 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node2  | 192.168.140.212 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node3  | 192.168.140.213 | CentOS Linux release 7.4.1708 | v1.20.2 |      |

官网文档[https://www.jenkins.io/doc/book/installing/kubernetes/](https://www.jenkins.io/doc/book/installing/kubernetes/)  

**安装过程**    

创建jenkins命名空间对资源进行隔离  

```
$ kubectl create namespace jenkins
```

列出命令空间  

```
$ kubectl get namespaces
```

编辑jenkins-deployment.yaml用于创建jenkins

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      containers:
      - name: jenkins
        image: jenkins/jenkins:lts-jdk11
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: jenkins-home
          mountPath: /var/jenkins_home
      volumes:
      - name: jenkins-home
        emptyDir: { }
```

部署jenkins

```
$ kubectl create -f jenkins-deployment.yaml -n jenkins
```

验证部署是否成功

```
$ kubectl get deployments -n jenkins
```

创建jenkins-service.yaml 用来暴露端口给外部访问，又名定义service

```
apiVersion: v1
kind: Service
metadata:
  name: jenkins
spec:
  type: NodePort
  ports:
  - port: 8080
    targetPort: 8080
  selector:
    app: jenkins
```

创建service

```
$ kubectl create -f jenkins-service.yaml -n jenkins
```

验证部署service是否成功，观察映射的port，这里是32664，之后登陆jenkin控制台用

```
[root@node3 ~]# kubectl get services -n jenkins
NAME      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
jenkins   NodePort   10.98.249.206   <none>        8080:29584/TCP   11s
```

查看jenkins pod名称，用来查看log

```
$ kubectl get pods -n jenkins
$ kubectl logs <pod_name> -n jenkins
```

日志内容如下，包括默认密码

>```
>
>*************************************************************
>*************************************************************
>*************************************************************
>
>Jenkins initial setup is required. An admin user has been created and a password generated.
>Please use the following password to proceed to installation:
>
>456b20d93bda48a7b4cea553fe198d43
>
>This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
>
>*************************************************************
>*************************************************************
>
>```

登陆jenkin控制台,用户名admin,密码是上面查看的密码

浏览器访问http://nodeip:29584

![](/img/2021-02-08/1.png)

登陆后界面如下，选择推荐的安装插件即可

![](/img/2021-02-08/2.png)

等待安装完成

![](/img/2021-02-08/3.png)

创建一个新的管理员账户，方便之后操作使用

![](/img/2021-02-08/4.png)

![](/img/2021-02-08/5.png)

首页展示如下

![](/img/2021-02-08/6.png)





声明：本博客的<img class="original" src='/img/original.png'>原创文章，都是本人平时学习所做的笔记，转载请标注出处，谢谢合作。