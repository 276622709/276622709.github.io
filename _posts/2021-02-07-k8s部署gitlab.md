---
layout: post
title: k8s部署gitlab
date: 2021-02-07
author: ZMY
header-img: ../img/2021-02-07/background.png
catalog : true
tags:
   - kubernetes
   - gitlab
typora-root-url: ..
---

## <img class="original" src='/img/original.png'>k8s部署gitlab

**环境描述**

| 主机名 | ip地址          | 操作系统                      | K8S版本 | 备注 |
| ------ | --------------- | ----------------------------- | ------- | ---- |
| master | 192.168.140.210 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node1  | 192.168.140.211 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node2  | 192.168.140.212 | CentOS Linux release 7.4.1708 | v1.20.2 |      |
| node3  | 192.168.140.213 | CentOS Linux release 7.4.1708 | v1.20.2 |      |

[官方gitlab项目地址](https://github.com/sameersbn/docker-gitlab)

git命令下载github上gitlab项目安装包

```
# yum install git -y
# git clone https://github.com/sameersbn/docker-gitlab.git
# cd docker-gitlab/kubernetes
```

vim gitlab-svc.yml

```
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  labels:
    name: gitlab
spec:
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: http
      nodePort: 10000
    - name: ssh
      port: 22
      targetPort: ssh
      nodePort: 10020
  selector:
    name: gitlab
```

vim gitlab-rc.yml 修改时间区域和登陆密码(至少8位)

```
- name: TZ
  value: Asia/Beijing
- name: GITLAB_TIMEZONE
  value: Beijing
- name: GITLAB_ROOT_PASSWORD
  value: ********

```

执行sh脚本

```
# sh deploy.sh
```

查看各pod状态,可以看到gitlab有问题

```
[root@master kubernetes]# kubectl get pod
NAME               READY   STATUS    RESTARTS   AGE
gitlab-7q4mq       0/1     Running   3          4m18s
postgresql-77f9h   1/1     Running   0          4m17s
redis-lpnbg        1/1     Running   0          4m16s
```

查看日志

```
# kubectl logs pod/gitlab-7q4mq -f
```

报错：

>psql:/home/git/gitlab/db/structure.sql:9: ERROR:  permission denied to create extension "btree_gist"
>HINT:  Must be superuser to create this extension.
>rake aborted!
>failed to execute:
>psql -v ON_ERROR_STOP=1 -q -X -f /home/git/gitlab/db/structure.sql --single-transaction gitlab_production
>
>Please check the output above for any errors and make sure that `psql` is installed in your PATH and has proper permissions.

解决办法：

https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/5612

修改postgresql-rc.yml中DB_EXTENSION对应的值

```
- name: DB_EXTENSION
  value: pg_trgm,btree_gist
```

执行# sh teardown.sh清除错误环境

```
# sh teardown.sh
```

重新创建gitlab实验环境

```
# sh deploy.sh
```

**gitlab建立后访问时会出现的情况**

1.gitlab容器自动重启  

内存不足，oom杀死gitlab容器，kubelet根据策略重启容器，然后gitlab消耗内存,oom杀死gitlab容器，循环下去 

2.gitlab所在容器节点变成不可用，且各节点轮流进去notReady状态  

内存不足，负载过高，还没触发oom，节点不能及时响应状态检测，导致gitlab所在节点状态不可用，然后根据启动策略，控制节点通过计算在健康状态节点上启动gitlab，杀死原来不好用的节点的gitlab容器（然后gitlab又因为内存不足，导致，io负载过高，然后循环下去

解决办法：

1.扩大物理机内存资源（因为我的是虚拟机环境，我直接扩展了内存资源）

2.限制gitlab使用资源，并预留systemd和kubernetes服务资源

**访问gitlab https://nodeip:10000 **

![](/img/2021-02-07/1.png)

![](/img/2021-02-07/2.png)

搭建gitlab是为了配合jenkins完成代码自动化部署过程，故gitlab涉及到的项目创建等过程，在后面搭建jenkins一起介绍  



声明：本博客的<img class="original" src='/img/original.png'>原创文章，都是本人平时学习所做的笔记，转载请标注出处，谢谢合作。